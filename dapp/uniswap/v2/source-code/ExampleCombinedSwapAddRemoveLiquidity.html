<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CombinedSwapAddRemoveLiquidity | UTXO</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/reco-blog/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.5.1">
    <script language="javascript" type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/reco-blog/js/MouseClickEffect.js"></script>
    <script language="javascript" type="text/javascript" src="https://wowjs.uk/dist/wow.min.js"></script>
    <meta name="description" content="投身区块链，寻找中本聪">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="theme-color" content="red">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/reco-blog/assets/css/0.styles.ef4512ae.css" as="style"><link rel="preload" href="/reco-blog/assets/js/app.1c503e6d.js" as="script"><link rel="preload" href="/reco-blog/assets/js/5.33311cc0.js" as="script"><link rel="preload" href="/reco-blog/assets/js/1.e254afbc.js" as="script"><link rel="preload" href="/reco-blog/assets/js/25.684f6337.js" as="script"><link rel="prefetch" href="/reco-blog/assets/js/10.d48c0071.js"><link rel="prefetch" href="/reco-blog/assets/js/11.1c7348fe.js"><link rel="prefetch" href="/reco-blog/assets/js/12.ef3b0432.js"><link rel="prefetch" href="/reco-blog/assets/js/13.c6d160d2.js"><link rel="prefetch" href="/reco-blog/assets/js/14.19068876.js"><link rel="prefetch" href="/reco-blog/assets/js/15.0f032483.js"><link rel="prefetch" href="/reco-blog/assets/js/16.784005fc.js"><link rel="prefetch" href="/reco-blog/assets/js/17.80437146.js"><link rel="prefetch" href="/reco-blog/assets/js/18.2bb0c25e.js"><link rel="prefetch" href="/reco-blog/assets/js/19.9108d0de.js"><link rel="prefetch" href="/reco-blog/assets/js/2.b8c4be99.js"><link rel="prefetch" href="/reco-blog/assets/js/20.e9518f69.js"><link rel="prefetch" href="/reco-blog/assets/js/21.34573f2b.js"><link rel="prefetch" href="/reco-blog/assets/js/22.11317c14.js"><link rel="prefetch" href="/reco-blog/assets/js/23.c017e830.js"><link rel="prefetch" href="/reco-blog/assets/js/24.1f11afa7.js"><link rel="prefetch" href="/reco-blog/assets/js/26.68de53d0.js"><link rel="prefetch" href="/reco-blog/assets/js/27.94fa6806.js"><link rel="prefetch" href="/reco-blog/assets/js/28.aa29b398.js"><link rel="prefetch" href="/reco-blog/assets/js/29.01807e8d.js"><link rel="prefetch" href="/reco-blog/assets/js/3.eecaba61.js"><link rel="prefetch" href="/reco-blog/assets/js/30.c43574b7.js"><link rel="prefetch" href="/reco-blog/assets/js/31.2a4dbea2.js"><link rel="prefetch" href="/reco-blog/assets/js/32.7fd296b9.js"><link rel="prefetch" href="/reco-blog/assets/js/33.96f5ccb7.js"><link rel="prefetch" href="/reco-blog/assets/js/34.8a991562.js"><link rel="prefetch" href="/reco-blog/assets/js/6.d510b5f6.js"><link rel="prefetch" href="/reco-blog/assets/js/7.a81d04cc.js"><link rel="prefetch" href="/reco-blog/assets/js/8.adf8f882.js"><link rel="prefetch" href="/reco-blog/assets/js/9.3079b055.js">
    <link rel="stylesheet" href="/reco-blog/assets/css/0.styles.ef4512ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-f3a80db0><div data-v-f3a80db0><div id="loading" class="loading-wrapper" data-v-7efa5e3f data-v-f3a80db0 data-v-f3a80db0><div id="loading-center" data-v-7efa5e3f><div id="loading-center-absolute" data-v-7efa5e3f><div id="object_four" class="object" data-v-7efa5e3f></div> <div id="object_three" class="object" data-v-7efa5e3f></div> <div id="object_two" class="object" data-v-7efa5e3f></div> <div id="object_one" class="object" data-v-7efa5e3f></div></div></div></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4d9229f4 data-v-f3a80db0 data-v-f3a80db0><h3 class="title" data-v-4d9229f4 data-v-4d9229f4>UTXO</h3> <p class="description" data-v-4d9229f4 data-v-4d9229f4>投身区块链，寻找中本聪</p> <label id="box" class="inputBox" data-v-4d9229f4 data-v-4d9229f4><input type="password" value="" data-v-4d9229f4> <span data-v-4d9229f4>解锁！解锁！</span> <button data-v-4d9229f4>OK</button></label> <div class="footer" data-v-4d9229f4 data-v-4d9229f4><span data-v-4d9229f4><i class="iconfont reco-theme" data-v-4d9229f4></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4d9229f4>vuePress-theme-reco</a></span> <span data-v-4d9229f4><i class="iconfont reco-copyright" data-v-4d9229f4></i> <a data-v-4d9229f4><span data-v-4d9229f4>我不是中本聪</span>
            
          <span data-v-4d9229f4>2017 - </span>
          2021
        </a></span></div></div> <div class="hide" data-v-f3a80db0><header class="navbar" style="z-index:99;" data-v-f3a80db0><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/reco-blog/" class="home-link router-link-active"><img src="/reco-blog/head.jpg" alt="UTXO" class="logo"> <span class="site-name">UTXO</span></a> <div class="links"><div class="color-picker"><div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark active">dark</li><li class="auto">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/reco-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/reco-blog/categories/DAPP/" class="nav-link"><i class="undefined"></i>
  DAPP
</a></li><li class="dropdown-item"><!----> <a href="/reco-blog/categories/智能合约/" class="nav-link"><i class="undefined"></i>
  智能合约
</a></li><li class="dropdown-item"><!----> <a href="/reco-blog/categories/Uniswap/" class="nav-link"><i class="undefined"></i>
  Uniswap
</a></li></ul></div></div><div class="nav-item"><a href="/reco-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      DAPP开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/reco-blog/dapp/tutorial/junior/explain/" class="nav-link"><i class="undefined"></i>
  DAPP教程
</a></li><li class="dropdown-item"><!----> <a href="/reco-blog/dapp/uniswap/v2/whitepaper/" class="nav-link"><i class="undefined"></i>
  Uniswap
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-suggestion"></i>
      TodoList
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react_ts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react_ts
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react_ts_mobx" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react_ts_mobx
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react-native_ts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react-native_ts 
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react-native_ts_mobx" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react-native_ts_mobx
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react_ts_mobx_eos" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react_ts_mobx_eos
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex_eos" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex_eos
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex_eos_ipfs" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex_eos_ipfs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex_eos_chrome" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex_eos_chrome_extensions
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react-native_ts_mobx_eos" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react-native_ts_mobx_eos
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/reco-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/reco-blog/guestbook/" class="nav-link"><i class="iconfont reco-suggestion"></i>
  留言板
</a></div><div class="nav-item"><a href="/reco-blog/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-github"></i>
      仓库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/reco-blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/qianduanxinlv/vuepress_blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-f3a80db0></div> <aside class="sidebar" data-v-f3a80db0><div class="personal-info-wrapper" data-v-1af3eea6 data-v-f3a80db0><img src="/reco-blog/head.jpg" alt="author-avatar" class="personal-img animated bounce" data-v-1af3eea6> <h3 class="name" data-v-1af3eea6>
    我不是中本聪
  </h3> <div class="num" data-v-1af3eea6><div data-v-1af3eea6><h3 data-v-1af3eea6>18</h3> <h6 data-v-1af3eea6>文章</h6></div> <div data-v-1af3eea6><h3 data-v-1af3eea6>5</h3> <h6 data-v-1af3eea6>标签</h6></div></div> <ul class="social-links" data-v-1af3eea6></ul> <hr data-v-1af3eea6></div> <nav class="nav-links"><div class="nav-item"><a href="/reco-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/reco-blog/categories/DAPP/" class="nav-link"><i class="undefined"></i>
  DAPP
</a></li><li class="dropdown-item"><!----> <a href="/reco-blog/categories/智能合约/" class="nav-link"><i class="undefined"></i>
  智能合约
</a></li><li class="dropdown-item"><!----> <a href="/reco-blog/categories/Uniswap/" class="nav-link"><i class="undefined"></i>
  Uniswap
</a></li></ul></div></div><div class="nav-item"><a href="/reco-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      DAPP开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/reco-blog/dapp/tutorial/junior/explain/" class="nav-link"><i class="undefined"></i>
  DAPP教程
</a></li><li class="dropdown-item"><!----> <a href="/reco-blog/dapp/uniswap/v2/whitepaper/" class="nav-link"><i class="undefined"></i>
  Uniswap
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-suggestion"></i>
      TodoList
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react_ts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react_ts
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react_ts_mobx" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react_ts_mobx
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react-native_ts" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react-native_ts 
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react-native_ts_mobx" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react-native_ts_mobx
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react_ts_mobx_eos" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react_ts_mobx_eos
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex_eos" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex_eos
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex_eos_ipfs" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex_eos_ipfs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/vue_js_vuex_eos_chrome" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  vue_js_vuex_eos_chrome_extensions
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/todolist/tree/master/react-native_ts_mobx_eos" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  react-native_ts_mobx_eos
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/reco-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><a href="/reco-blog/guestbook/" class="nav-link"><i class="iconfont reco-suggestion"></i>
  留言板
</a></div><div class="nav-item"><a href="/reco-blog/about/" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-github"></i>
      仓库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/xiangzhengfeng/reco-blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/qianduanxinlv/vuepress_blog" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Uniswap-V2</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/reco-blog/dapp/uniswap/v2/whitepaper/" class="sidebar-link">Uniswap-V2白皮书</a></li><li><a href="/reco-blog/dapp/uniswap/v2/explain/" class="sidebar-link">Uniswap-V2讲解</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/" aria-current="page" class="sidebar-link">Uniswap V2 源码浅析</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/UniswapV2ERC20.html" class="sidebar-link">UniswapV2ERC20</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/UniswapV2Pair.html" class="sidebar-link">UniswapV2Pair</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/UniswapV2Factory.html" class="sidebar-link">UniswapV2Factory</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/UniswapV2Router02.html" class="sidebar-link">UniswapV2Router02</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/UniswapV2Migrator.html" class="sidebar-link">UniswapV2Migrator</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleOracleSimple.html" class="sidebar-link">ExampleOracleSimple</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleSlidingWindowOracle.html" class="sidebar-link">ExampleSlidingWindowOracle</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleSwapToPrice.html" class="sidebar-link">ExampleSwapToPrice</a></li><li><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html" aria-current="page" class="active sidebar-link">CombinedSwapAddRemoveLiquidity</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4d9229f4 data-v-f3a80db0><h3 class="title" data-v-4d9229f4 data-v-4d9229f4>CombinedSwapAddRemoveLiquidity</h3> <!----> <label id="box" class="inputBox" data-v-4d9229f4 data-v-4d9229f4><input type="password" value="" data-v-4d9229f4> <span data-v-4d9229f4>解锁！解锁！</span> <button data-v-4d9229f4>OK</button></label> <div class="footer" data-v-4d9229f4 data-v-4d9229f4><span data-v-4d9229f4><i class="iconfont reco-theme" data-v-4d9229f4></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4d9229f4>vuePress-theme-reco</a></span> <span data-v-4d9229f4><i class="iconfont reco-copyright" data-v-4d9229f4></i> <a data-v-4d9229f4><span data-v-4d9229f4>我不是中本聪</span>
            
          <span data-v-4d9229f4>2017 - </span>
          2021
        </a></span></div></div> <div data-v-f3a80db0><main class="page"><section><div class="page-title"><h1 class="title">CombinedSwapAddRemoveLiquidity</h1> <div data-v-31ea8b86><i class="iconfont reco-account" data-v-31ea8b86><span data-v-31ea8b86>我不是中本聪</span></i> <i class="iconfont reco-date" data-v-31ea8b86><span data-v-31ea8b86>2021-03-21</span></i> <!----> <i class="tags iconfont reco-tag" data-v-31ea8b86><span class="tag-item" data-v-31ea8b86>智能合约</span><span class="tag-item" data-v-31ea8b86>Uniswap</span></i></div></div> <div class="theme-reco-content content__default"><p><a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/swap-before-liquidity-events/contracts/examples/ExampleCombinedSwapAddRemoveLiquidity.sol" target="_blank" rel="noopener noreferrer">ExampleCombinedSwapAddRemoveLiquidity<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>合约源码不在周边合约uniswap-v2-periphery的master分支下，而是位于<a href="https://github.com/Uniswap/uniswap-v2-periphery/tree/swap-before-liquidity-events" target="_blank" rel="noopener noreferrer">swap-before-liquidity-events<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>分支下。所在目录为examples目录。</p> <h2 id="combinedswapaddremoveliquidity源码"><a href="#combinedswapaddremoveliquidity源码" class="header-anchor">#</a> CombinedSwapAddRemoveLiquidity源码</h2> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">=</span><span class="token number">0.6</span><span class="token number">.6</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Factory.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Pair.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@uniswap/lib/contracts/libraries/Babylonian.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@uniswap/lib/contracts/libraries/TransferHelper.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;../interfaces/IUniswapV2Router01.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;../interfaces/IWETH.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;../interfaces/IERC20.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;../libraries/SafeMath.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;../libraries/UniswapV2Library.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// enables adding and removing liquidity with a single token to/from a pair</span>
<span class="token comment">// adds liquidity via a single token of the pair, by first swapping against the pair and then adding liquidity</span>
<span class="token comment">// removes liquidity in a single token, by removing liquidity and then immediately swapping</span>
<span class="token keyword">contract</span> <span class="token class-name">ExampleCombinedSwapAddRemoveLiquidity</span> <span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token class-name">SafeMath</span> <span class="token keyword">for</span> <span class="token builtin">uint</span><span class="token punctuation">;</span>

    IUniswapV2Factory <span class="token keyword">public</span> immutable factory<span class="token punctuation">;</span>
    IUniswapV2Router01 <span class="token keyword">public</span> immutable router<span class="token punctuation">;</span>
    IWETH <span class="token keyword">public</span> immutable weth<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>IUniswapV2Factory factory_<span class="token punctuation">,</span> IUniswapV2Router01 router_<span class="token punctuation">,</span> IWETH weth_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        factory <span class="token operator">=</span> factory_<span class="token punctuation">;</span>
        router <span class="token operator">=</span> router_<span class="token punctuation">;</span>
        weth <span class="token operator">=</span> weth_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// grants unlimited approval for a token to the router unless the existing allowance is high enough</span>
    <span class="token keyword">function</span> <span class="token function">approveRouter</span><span class="token punctuation">(</span><span class="token builtin">address</span> _token<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> allowance <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allowance</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allowance <span class="token operator">&lt;</span> _amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>allowance <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// clear the existing allowance</span>
                TransferHelper<span class="token punctuation">.</span><span class="token function">safeApprove</span><span class="token punctuation">(</span>_token<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            TransferHelper<span class="token punctuation">.</span><span class="token function">safeApprove</span><span class="token punctuation">(</span>_token<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// returns the amount of token that should be swapped in such that ratio of reserves in the pair is equivalent</span>
    <span class="token comment">// to the swapper's ratio of tokens</span>
    <span class="token comment">// note this depends only on the number of tokens the caller wishes to swap and the current reserves of that token,</span>
    <span class="token comment">// and not the current reserves of the other token</span>
    <span class="token keyword">function</span> <span class="token function">calculateSwapInAmount</span><span class="token punctuation">(</span><span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> userIn<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Babylonian<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>userIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">3988000</span><span class="token punctuation">)</span> <span class="token operator">+</span> reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">3988009</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1997</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1994</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// internal function shared by the ETH/non-ETH versions</span>
    <span class="token keyword">function</span> <span class="token function">_swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span> tokenIn<span class="token punctuation">,</span>
        <span class="token builtin">address</span> otherToken<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> minOtherTokenIn<span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> deadline
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountTokenIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountTokenOther<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// compute how much we should swap in to match the reserve ratio of tokenIn / otherToken of the pair</span>
        <span class="token builtin">uint</span> swapInAmount<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">getReserves</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">,</span> tokenIn<span class="token punctuation">,</span> otherToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            swapInAmount <span class="token operator">=</span> <span class="token function">calculateSwapInAmount</span><span class="token punctuation">(</span>reserveIn<span class="token punctuation">,</span> amountIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// first take possession of the full amount from the caller, unless caller is this contract</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>tokenIn<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amountIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// approve for the swap, and then later the add liquidity. total is amountIn</span>
        <span class="token function">approveRouter</span><span class="token punctuation">(</span>tokenIn<span class="token punctuation">,</span> amountIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">{</span>
            <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tokenIn<span class="token punctuation">;</span>
            path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> otherToken<span class="token punctuation">;</span>

            amountTokenOther <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">swapExactTokensForTokens</span><span class="token punctuation">(</span>
                swapInAmount<span class="token punctuation">,</span>
                minOtherTokenIn<span class="token punctuation">,</span>
                path<span class="token punctuation">,</span>
                <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                deadline
            <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// approve the other token for the add liquidity call</span>
        <span class="token function">approveRouter</span><span class="token punctuation">(</span>otherToken<span class="token punctuation">,</span> amountTokenOther<span class="token punctuation">)</span><span class="token punctuation">;</span>
        amountTokenIn <span class="token operator">=</span> amountIn<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>swapInAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// no need to check that we transferred everything because minimums == total balance of this contract</span>
        <span class="token punctuation">(</span><span class="token punctuation">,</span><span class="token punctuation">,</span>liquidity<span class="token punctuation">)</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">addLiquidity</span><span class="token punctuation">(</span>
            tokenIn<span class="token punctuation">,</span>
            otherToken<span class="token punctuation">,</span>
        <span class="token comment">// desired amountA, amountB</span>
            amountTokenIn<span class="token punctuation">,</span>
            amountTokenOther<span class="token punctuation">,</span>
        <span class="token comment">// amountTokenIn and amountTokenOther should match the ratio of reserves of tokenIn to otherToken</span>
        <span class="token comment">// thus we do not need to constrain the minimums here</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            deadline
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// computes the exact amount of tokens that should be swapped before adding liquidity for a given token</span>
    <span class="token comment">// does the swap and then adds liquidity</span>
    <span class="token comment">// minOtherToken should be set to the minimum intermediate amount of token1 that should be received to prevent</span>
    <span class="token comment">// excessive slippage or front running</span>
    <span class="token comment">// liquidity provider shares are minted to the 'to' address</span>
    <span class="token keyword">function</span> <span class="token function">swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> tokenIn<span class="token punctuation">,</span>
        <span class="token builtin">address</span> otherToken<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> minOtherTokenIn<span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> deadline
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountTokenIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountTokenOther<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> tokenIn<span class="token punctuation">,</span> otherToken<span class="token punctuation">,</span> amountIn<span class="token punctuation">,</span> minOtherTokenIn<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// similar to the above method but handles converting ETH to WETH</span>
    <span class="token keyword">function</span> <span class="token function">swapExactETHAndAddLiquidity</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> token<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> minTokenIn<span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> deadline
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountETHIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountTokenIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        weth<span class="token punctuation">.</span>deposit<span class="token punctuation">{</span>value<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">_swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>weth<span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> minTokenIn<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// internal function shared by the ETH/non-ETH versions</span>
    <span class="token keyword">function</span> <span class="token function">_removeLiquidityAndSwap</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span> undesiredToken<span class="token punctuation">,</span>
        <span class="token builtin">address</span> desiredToken<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> minDesiredTokenOut<span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> deadline
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountDesiredTokenOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">address</span> pair <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">,</span> undesiredToken<span class="token punctuation">,</span> desiredToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// take possession of liquidity and give access to the router</span>
        TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">approveRouter</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span><span class="token builtin">uint</span> amountInToSwap<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountOutToTransfer<span class="token punctuation">)</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">removeLiquidity</span><span class="token punctuation">(</span>
            undesiredToken<span class="token punctuation">,</span>
            desiredToken<span class="token punctuation">,</span>
            liquidity<span class="token punctuation">,</span>
        <span class="token comment">// amount minimums are applied in the swap</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token comment">// contract must receive both tokens because we want to swap the undesired token</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            deadline
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// send the amount in that we received in the burn</span>
        <span class="token function">approveRouter</span><span class="token punctuation">(</span>undesiredToken<span class="token punctuation">,</span> amountInToSwap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> undesiredToken<span class="token punctuation">;</span>
        path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> desiredToken<span class="token punctuation">;</span>

        <span class="token builtin">uint</span> amountOutSwap <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">swapExactTokensForTokens</span><span class="token punctuation">(</span>
            amountInToSwap<span class="token punctuation">,</span>
        <span class="token comment">// we must get at least this much from the swap to meet the minDesiredTokenOut parameter</span>
            minDesiredTokenOut <span class="token operator">&gt;</span> amountOutToTransfer <span class="token operator">?</span> minDesiredTokenOut <span class="token operator">-</span> amountOutToTransfer <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            path<span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            deadline
        <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// we do this after the swap to save gas in the case where we do not meet the minimum output</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransfer</span><span class="token punctuation">(</span>desiredToken<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amountOutToTransfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        amountDesiredTokenOut <span class="token operator">=</span> amountOutToTransfer <span class="token operator">+</span> amountOutSwap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// burn the liquidity and then swap one of the two tokens to the other</span>
    <span class="token comment">// enforces that at least minDesiredTokenOut tokens are received from the combination of burn and swap</span>
    <span class="token keyword">function</span> <span class="token function">removeLiquidityAndSwapToToken</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> undesiredToken<span class="token punctuation">,</span>
        <span class="token builtin">address</span> desiredToken<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> minDesiredTokenOut<span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> deadline
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountDesiredTokenOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_removeLiquidityAndSwap</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> undesiredToken<span class="token punctuation">,</span> desiredToken<span class="token punctuation">,</span> liquidity<span class="token punctuation">,</span> minDesiredTokenOut<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// only WETH can send to this contract without a function call.</span>
    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>weth<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'CombinedSwapAddRemoveLiquidity: RECEIVE_NOT_FROM_WETH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// similar to the above method but for when the desired token is WETH, handles unwrapping</span>
    <span class="token keyword">function</span> <span class="token function">removeLiquidityAndSwapToETH</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> token<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> minDesiredETH<span class="token punctuation">,</span>
        <span class="token builtin">address</span> to<span class="token punctuation">,</span>
        <span class="token builtin">uint</span> deadline
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountETHOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do the swap remove and swap to this address</span>
        amountETHOut <span class="token operator">=</span> <span class="token function">_removeLiquidityAndSwap</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>weth<span class="token punctuation">)</span><span class="token punctuation">,</span> liquidity<span class="token punctuation">,</span> minDesiredETH<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deadline
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// now withdraw to ETH and forward to the recipient</span>
        weth<span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span>amountETHOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferETH</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> amountETHOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br></div></div><h2 id="combinedswapaddremoveliquidity源码解析"><a href="#combinedswapaddremoveliquidity源码解析" class="header-anchor">#</a> CombinedSwapAddRemoveLiquidity源码解析</h2> <h3 id="_1-单资产流动性供给"><a href="#_1-单资产流动性供给" class="header-anchor">#</a> 1. 单资产流动性供给</h3> <p>我们知道，Uniswap在提供流动性时必须同时按比例注入交易对中的两种资产，然后得到流动性代币。同时需要两种资产，这无形中提高了用户的门槛。如果用户只有一种（或者只关注一种）资产怎么办呢？能不能提供流动性供给？答案可以的。</p> <p>在Router合约中提供了流动性管理的接口，同时也提供了资产交易的接口。那么我们可以在同一个函数里将这两个功能联合起来，先交易资产然后再提供流动性，或者先移除流动性再交易资产。</p> <p>如果单资产提供流动性，先要在提供的资产中分一部分出来进行交易，得到另外一种资产，这样就有两种资产了。然后再调用Router合约的增加流动性接口注入资产提供流动性。那么分多少资产出来进行交易才能保证资产全部注入（注入时的比例和交易后交易对中的比例相同），是这个操作的核心，需要使用公式进行计算。</p> <p>如果移除流动性并得到单资产，这个相对简单很多。先移除流动性得到两种资产，然后再将其中一种资产兑换成另一种即可。这样得到的资产就是提取的数量加上交易得到的数量。</p> <p>可以看到，对Uniswap来讲，这里的单资产流动性供给实质还是双资产注入（其底层实现决定的），只是提前将单资产兑换成了双资产。</p> <p>注：这里还有其它类型的单资产流动性供给，例如BancorV2(班科第二版)及一些类似的DEFI。他们并不需要将单资产兑换成双资产，而是在交易对中为每种资产都生成一个流动性代币，从而实现单资产注入。</p> <h3 id="_2-构造器"><a href="#_2-构造器" class="header-anchor">#</a> 2. 构造器</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token keyword">constructor</span><span class="token punctuation">(</span>IUniswapV2Factory factory_<span class="token punctuation">,</span> IUniswapV2Router01 router_<span class="token punctuation">,</span> IWETH weth_<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
  factory <span class="token operator">=</span> factory_<span class="token punctuation">;</span>
  router <span class="token operator">=</span> router_<span class="token punctuation">;</span>
  weth <span class="token operator">=</span> weth_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>constructor，构造器。这里构造器参数直接使用了合约类型的变量而不是地址类型的变量。 这个和我们平常的用法不太一致，不过合约类型它对外ABI类型仍然为地址类型。经过测试，外部部署时这里直接使用地址类型作为构造器参数是可行的。但是如果在合约内创建该合约（使用new创建），构造器参数必须为合约类型，不能为地址类型。</p> <h3 id="_3-approverouter函数"><a href="#_3-approverouter函数" class="header-anchor">#</a> 3. approveRouter函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// grants unlimited approval for a token to the router unless the existing allowance is high enough</span>
<span class="token keyword">function</span> <span class="token function">approveRouter</span><span class="token punctuation">(</span><span class="token builtin">address</span> _token<span class="token punctuation">,</span> <span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
  <span class="token builtin">uint256</span> allowance <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allowance</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>allowance <span class="token operator">&lt;</span> _amount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>allowance <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// clear the existing allowance</span>
          TransferHelper<span class="token punctuation">.</span><span class="token function">safeApprove</span><span class="token punctuation">(</span>_token<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      TransferHelper<span class="token punctuation">.</span><span class="token function">safeApprove</span><span class="token punctuation">(</span>_token<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>approveRouter函数，将单资产的代币进行授权，授权对象为Router合约，授权额度为用户输入。注意，这里是本合约进行授权，而不是用户进行授权。因为Router合约最后转移的是本合约的代币。它的注释解释了它的逻辑，但是重新授权为一个新值前清除了原来的授权，为什么这样做呢？估计是为了更保险吧，因为你不知道第三方ERC20合约到底是怎样实现的。</p> <h3 id="_4-calculateswapinamount函数"><a href="#_4-calculateswapinamount函数" class="header-anchor">#</a> 4. calculateSwapInAmount函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// returns the amount of token that should be swapped in such that ratio of reserves in the pair is equivalent</span>
<span class="token comment">// to the swapper's ratio of tokens</span>
<span class="token comment">// note this depends only on the number of tokens the caller wishes to swap and the current reserves of that token,</span>
<span class="token comment">// and not the current reserves of the other token</span>
<span class="token keyword">function</span> <span class="token function">calculateSwapInAmount</span><span class="token punctuation">(</span><span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> userIn<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Babylonian<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>userIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">3988000</span><span class="token punctuation">)</span> <span class="token operator">+</span> reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">3988009</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1997</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1994</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>calculateSwapInAmount函数。核心函数，计算单资产注入时用户需要先分离多少资产先进行交换。它的两个输入参数分别为当前交易对中某种资产数量和用户欲注入的单资产数量。注释中提到这个计算和交易对中另一种资产没有关系，但具体怎么计算出来的，目前笔者还不清楚。</p> <h3 id="_5-calculateswapinamount函数"><a href="#_5-calculateswapinamount函数" class="header-anchor">#</a> 5. calculateSwapInAmount函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// internal function shared by the ETH/non-ETH versions</span>
<span class="token keyword">function</span> <span class="token function">_swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
  <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span>
  <span class="token builtin">address</span> tokenIn<span class="token punctuation">,</span>
  <span class="token builtin">address</span> otherToken<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> minOtherTokenIn<span class="token punctuation">,</span>
  <span class="token builtin">address</span> to<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountTokenIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountTokenOther<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// compute how much we should swap in to match the reserve ratio of tokenIn / otherToken of the pair</span>
  <span class="token builtin">uint</span> swapInAmount<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">getReserves</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">,</span> tokenIn<span class="token punctuation">,</span> otherToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
      swapInAmount <span class="token operator">=</span> <span class="token function">calculateSwapInAmount</span><span class="token punctuation">(</span>reserveIn<span class="token punctuation">,</span> amountIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// first take possession of the full amount from the caller, unless caller is this contract</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">from</span> <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>tokenIn<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amountIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// approve for the swap, and then later the add liquidity. total is amountIn</span>
  <span class="token function">approveRouter</span><span class="token punctuation">(</span>tokenIn<span class="token punctuation">,</span> amountIn<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
      <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tokenIn<span class="token punctuation">;</span>
      path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> otherToken<span class="token punctuation">;</span>

      amountTokenOther <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">swapExactTokensForTokens</span><span class="token punctuation">(</span>
          swapInAmount<span class="token punctuation">,</span>
          minOtherTokenIn<span class="token punctuation">,</span>
          path<span class="token punctuation">,</span>
          <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          deadline
      <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// approve the other token for the add liquidity call</span>
  <span class="token function">approveRouter</span><span class="token punctuation">(</span>otherToken<span class="token punctuation">,</span> amountTokenOther<span class="token punctuation">)</span><span class="token punctuation">;</span>
  amountTokenIn <span class="token operator">=</span> amountIn<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>swapInAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// no need to check that we transferred everything because minimums == total balance of this contract</span>
  <span class="token punctuation">(</span><span class="token punctuation">,</span><span class="token punctuation">,</span>liquidity<span class="token punctuation">)</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">addLiquidity</span><span class="token punctuation">(</span>
      tokenIn<span class="token punctuation">,</span>
      otherToken<span class="token punctuation">,</span>
  <span class="token comment">// desired amountA, amountB</span>
      amountTokenIn<span class="token punctuation">,</span>
      amountTokenOther<span class="token punctuation">,</span>
  <span class="token comment">// amountTokenIn and amountTokenOther should match the ratio of reserves of tokenIn to otherToken</span>
  <span class="token comment">// thus we do not need to constrain the minimums here</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      deadline
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>_swapExactTokensAndAddLiquidity函数。一个内部函数，看名称就知道，单资产注入时先交换资产然后增加流动性。多个外部接口使用相同的逻辑，所以把相同提取成了一个独立的内部函数。
函数输入参数：</p> <ul><li>from是从本合约还是从哪转移资产。</li> <li>tokenIn与otherToken。交易对中单资产注入的代币地址及另一种代币地址。</li> <li>amountIn，用户拟注入的总数量，其中一部分会先进行交易，兑换成另一种代币。</li> <li>minOtherTokenIn，中间过程兑换成另一种代币的最小数量`。</li> <li>to，接收流动性地址。</li> <li>deadline，最晚交易时间。</li></ul> <p>函数输出参数：</p> <ul><li>amountTokenIn，拟注入的单资产中，参与交易（兑换）部分的数量。</li> <li>amountTokenOther，中间过程兑换成另一种代币的数量。</li> <li>liquidity，最后得到的流动性。</li></ul> <p>函数代码：</p> <ul><li>前四行，首先，得到交易对中欲注入的那种资产的数量（使用工具库函数计算）。接着，调用calculateSwapInAmount函数计算拟注入的资产中参与交易（兑换）的数量。</li> <li>5-7行。如果拟注入的资产来源不是本合约，就先将所有拟注入的资产转移到本合约（这样本合约就有相应资产了）。这个过程中会需要授权转移。</li> <li>第8行。本合约对注入的资产进行授权，授权对象为路由合约，授权额度为拟注入的资产数量。</li> <li>接下来一对{}里的内容是调用Router合约的swapExactTokensForTokens方法，将swapInAmount数量的注入资产兑换成另一种资产。注意接收地址为本地址，因为接下来还要用接收的另一种资产实现提供流动性功能。后面为什么还有一个[1]呢，因为swapExactTokensForTokens函数返回的是两种代币的参与数量，是一个数组。数组内元素顺序和交易路径一致，所以[1]代表得到的另一种资产数量。</li> <li>approveRouter(otherToken, amountTokenOther);对得到的另一种资产也进行授权（不然提供流动性时Router合约无法转移走）。授权对象为Router合约，额度就是得到的另一种资产数量（也是注入数量）。</li> <li>amountTokenIn = amountIn.sub(swapInAmount);计算实际参与提供流动性的初始资产数量，为拟注入的数量减去参与交易的数量。</li> <li>最后就是调用Router合约的addLiquidity函数进行提供流动性操作。可以看一**释的一些解释。</li></ul> <h3 id="_6-swapexacttokensandaddliquidity函数"><a href="#_6-swapexacttokensandaddliquidity函数" class="header-anchor">#</a> 6. swapExactTokensAndAddLiquidity函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// computes the exact amount of tokens that should be swapped before adding liquidity for a given token</span>
<span class="token comment">// does the swap and then adds liquidity</span>
<span class="token comment">// minOtherToken should be set to the minimum intermediate amount of token1 that should be received to prevent</span>
<span class="token comment">// excessive slippage or front running</span>
<span class="token comment">// liquidity provider shares are minted to the 'to' address</span>
<span class="token keyword">function</span> <span class="token function">swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> tokenIn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> otherToken<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> minOtherTokenIn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> to<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountTokenIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountTokenOther<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> tokenIn<span class="token punctuation">,</span> otherToken<span class="token punctuation">,</span> amountIn<span class="token punctuation">,</span> minOtherTokenIn<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>swapExactTokensAndAddLiquidity函数。用户实际调用的外部接口，欲注入的单向资产为普通ERC20代币。此时，直接调用_swapExactTokensAndAddLiquidity函数即可。</p> <h3 id="_7-swapexactethandaddliquidity函数"><a href="#_7-swapexactethandaddliquidity函数" class="header-anchor">#</a> 7. swapExactETHAndAddLiquidity函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// similar to the above method but handles converting ETH to WETH</span>
<span class="token keyword">function</span> <span class="token function">swapExactETHAndAddLiquidity</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> token<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> minTokenIn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> to<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountETHIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountTokenIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    weth<span class="token punctuation">.</span>deposit<span class="token punctuation">{</span>value<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_swapExactTokensAndAddLiquidity</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>weth<span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">,</span> minTokenIn<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>swapExactETHAndAddLiquidity函数。用户实际调用的外部接口，欲注入的单向资产为ETH。因为用户欲注入的资产为ETH，所以UniswapV2交易对必定为WETH/ERC20交易对。这个函数和上面的函数相比，仅多了一个将ETH兑换成WETH的步骤，其它几乎完全一样。注意到因为兑换后的WETH在本合约（不在用户身上），所以调用_swapExactTokensAndAddLiquidity函数时第一个参数为address(this)。</p> <h3 id="_8-removeliquidityandswap函数"><a href="#_8-removeliquidityandswap函数" class="header-anchor">#</a> 8. _removeLiquidityAndSwap函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// internal function shared by the ETH/non-ETH versions</span>
<span class="token keyword">function</span> <span class="token function">_removeLiquidityAndSwap</span><span class="token punctuation">(</span>
  <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span>
  <span class="token builtin">address</span> undesiredToken<span class="token punctuation">,</span>
  <span class="token builtin">address</span> desiredToken<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> minDesiredTokenOut<span class="token punctuation">,</span>
  <span class="token builtin">address</span> to<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountDesiredTokenOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">address</span> pair <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">,</span> undesiredToken<span class="token punctuation">,</span> desiredToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// take possession of liquidity and give access to the router</span>
  TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">approveRouter</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">(</span><span class="token builtin">uint</span> amountInToSwap<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountOutToTransfer<span class="token punctuation">)</span> <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">removeLiquidity</span><span class="token punctuation">(</span>
      undesiredToken<span class="token punctuation">,</span>
      desiredToken<span class="token punctuation">,</span>
      liquidity<span class="token punctuation">,</span>
  <span class="token comment">// amount minimums are applied in the swap</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token comment">// contract must receive both tokens because we want to swap the undesired token</span>
      <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      deadline
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// send the amount in that we received in the burn</span>
  <span class="token function">approveRouter</span><span class="token punctuation">(</span>undesiredToken<span class="token punctuation">,</span> amountInToSwap<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> undesiredToken<span class="token punctuation">;</span>
  path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> desiredToken<span class="token punctuation">;</span>

  <span class="token builtin">uint</span> amountOutSwap <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">swapExactTokensForTokens</span><span class="token punctuation">(</span>
      amountInToSwap<span class="token punctuation">,</span>
  <span class="token comment">// we must get at least this much from the swap to meet the minDesiredTokenOut parameter</span>
      minDesiredTokenOut <span class="token operator">&gt;</span> amountOutToTransfer <span class="token operator">?</span> minDesiredTokenOut <span class="token operator">-</span> amountOutToTransfer <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      path<span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      deadline
  <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// we do this after the swap to save gas in the case where we do not meet the minimum output</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransfer</span><span class="token punctuation">(</span>desiredToken<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amountOutToTransfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  amountDesiredTokenOut <span class="token operator">=</span> amountOutToTransfer <span class="token operator">+</span> amountOutSwap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>_removeLiquidityAndSwap函数。和_swapExactTokensAndAddLiquidity函数类似，不过是移除流动性然后交易，可以看出它和_swapExactTokensAndAddLiquidity函数的流程刚好相反。大家参照上面的_swapExactTokensAndAddLiquidity函数来看一下本函数的输入参数和输出参数。undesiredToken代表另一种资产，desiredToken代表自己最后想要的资产。注意，先移除流动性然后交易没有计算优化值，和普通的分开操作没有区别。我们直接来看函数代码：</p> <ul><li>第一行获取交易对地址</li> <li>第二行将欲移除的流动性转移到本合约。</li> <li>第三行对流动性进行授权，授权对象为Router合约，额度为欲移除的流动性的数值。</li> <li>接下来是一个Router合约的removeLiquidity调用，移除流动性，提取两种资产。注意接收地址为本合约地址，因为后面还要交易呢。它返回两个值，就是提取的两种资产的值。它们的顺序就是输入参数中undesiredToken和desiredToken顺序，与之相对应。</li> <li>approveRouter(undesiredToken, amountInToSwap);，对不想要的另一种资产进行授权，对象为Router合约，额度为全部数量。</li> <li>接下来三行构建一个交易路径，为交易资产做准备。</li> <li>接下来调用Router合约的swapExactTokensForTokens方法，将不想要的另一种资产兑换成想要的资产。这里的[1] 意义和上面讲到的类似，为交易得到的资产数量。同时还需要注意它设置的最小得到数量的逻辑：如果先前提取时得到的数量已经超过了用户定义的最小值，这里就不需要了，设置为0；如果小于怎么办？那么交易至少要得到两者之间的差额（也就是最小值设置），否则无法达到满足用户预期。
if (to != address(this))代码断，如果交易的接收地址不为本合约地址，假如为外部地址。因为此时移除流动性时提取的资产还在本合约中（与to不一致），所以需要将提取的资产也发送到to地址去。如果为本合约地址，说明所有得到的资产全在本合约中，同to一致，无需处理。</li> <li>最后一行计算得到的单资产总数量。数值为提取的数量加上兑换的数量。</li></ul> <h3 id="_9-removeliquidityandswaptotoken函数"><a href="#_9-removeliquidityandswaptotoken函数" class="header-anchor">#</a> 9. removeLiquidityAndSwapToToken函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// burn the liquidity and then swap one of the two tokens to the other</span>
<span class="token comment">// enforces that at least minDesiredTokenOut tokens are received from the combination of burn and swap</span>
<span class="token keyword">function</span> <span class="token function">removeLiquidityAndSwapToToken</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> undesiredToken<span class="token punctuation">,</span>
    <span class="token builtin">address</span> desiredToken<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> minDesiredTokenOut<span class="token punctuation">,</span>
    <span class="token builtin">address</span> to<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountDesiredTokenOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_removeLiquidityAndSwap</span><span class="token punctuation">(</span>
        msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> undesiredToken<span class="token punctuation">,</span> desiredToken<span class="token punctuation">,</span> liquidity<span class="token punctuation">,</span> minDesiredTokenOut<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>removeLiquidityAndSwapToToken函数。学习了_removeLiquidityAndSwap函数，这个就很简单了，它是用户调用的外部接口，得到单一ERC20代币。本函数直接调用了_removeLiquidityAndSwap函数。</p> <h3 id="_10-receive函数"><a href="#_10-receive函数" class="header-anchor">#</a> 10. receive函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// only WETH can send to this contract without a function call.</span>
<span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">payable</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>weth<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'CombinedSwapAddRemoveLiquidity: RECEIVE_NOT_FROM_WETH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>receive函数。只接受WETH合约发送过来的ETH，因为本合约只与WETH合约发生ETH相互发送（用于ETH/WETH兑换）。</p> <h3 id="_11-removeliquidityandswaptoeth函数"><a href="#_11-removeliquidityandswaptoeth函数" class="header-anchor">#</a> 11. removeLiquidityAndSwapToETH函数</h3> <div class="language-sol line-numbers-mode"><pre class="language-sol"><code><span class="token comment">// similar to the above method but for when the desired token is WETH, handles unwrapping</span>
<span class="token keyword">function</span> <span class="token function">removeLiquidityAndSwapToETH</span><span class="token punctuation">(</span>
  <span class="token builtin">address</span> token<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> minDesiredETH<span class="token punctuation">,</span>
  <span class="token builtin">address</span> to<span class="token punctuation">,</span>
  <span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountETHOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do the swap remove and swap to this address</span>
  amountETHOut <span class="token operator">=</span> <span class="token function">_removeLiquidityAndSwap</span><span class="token punctuation">(</span>
      msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span>weth<span class="token punctuation">)</span><span class="token punctuation">,</span> liquidity<span class="token punctuation">,</span> minDesiredETH<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deadline
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// now withdraw to ETH and forward to the recipient</span>
  weth<span class="token punctuation">.</span><span class="token function">withdraw</span><span class="token punctuation">(</span>amountETHOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
  TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferETH</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> amountETHOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>removeLiquidityAndSwapToETH函数，也很简单，只不过将得到的单一资产变成了ERC20代币。首先直接调用_removeLiquidityAndSwap得到WETH这种单一资产（注意此时to地址为本合约，因为用户指定得到ETH，需要再兑换一下）。接着将WETH兑换成ETH，最后将得到的ETH发送给接收者地址to。</p> <h2 id="引用及知识拓展"><a href="#引用及知识拓展" class="header-anchor">#</a> 引用及知识拓展</h2> <ul><li><a href="https://ethfans.org/posts/getting-the-most-out-of-create2" target="_blank" rel="noopener noreferrer">充分利用 CREATE2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://learnblockchain.cn/2019/10/23/create2-statechannel/" target="_blank" rel="noopener noreferrer">CREATE2 在广义状态通道中的使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://ctf-wiki.org/blockchain/ethereum/attacks/create2/" target="_blank" rel="noopener noreferrer">CREATE2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/Programmer_CJC/article/details/80190058?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-1.control" target="_blank" rel="noopener noreferrer">Solidity原理（三）：abi编码以及与EVM交互的原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://blog.csdn.net/qq_35434814/article/details/104682616" target="_blank" rel="noopener noreferrer">solidity学习过程 --- abi编码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleSwapToPrice.html" class="prev">
            ExampleSwapToPrice
          </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-106c08ae><li class="level-2" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#combinedswapaddremoveliquidity源码" class="sidebar-link reco-side-combinedswapaddremoveliquidity源码" data-v-106c08ae>CombinedSwapAddRemoveLiquidity源码</a></li><li class="level-2" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#combinedswapaddremoveliquidity源码解析" class="sidebar-link reco-side-combinedswapaddremoveliquidity源码解析" data-v-106c08ae>CombinedSwapAddRemoveLiquidity源码解析</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_1-单资产流动性供给" class="sidebar-link reco-side-_1-单资产流动性供给" data-v-106c08ae>1. 单资产流动性供给</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_2-构造器" class="sidebar-link reco-side-_2-构造器" data-v-106c08ae>2. 构造器</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_3-approverouter函数" class="sidebar-link reco-side-_3-approverouter函数" data-v-106c08ae>3. approveRouter函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_4-calculateswapinamount函数" class="sidebar-link reco-side-_4-calculateswapinamount函数" data-v-106c08ae>4. calculateSwapInAmount函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_5-calculateswapinamount函数" class="sidebar-link reco-side-_5-calculateswapinamount函数" data-v-106c08ae>5. calculateSwapInAmount函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_6-swapexacttokensandaddliquidity函数" class="sidebar-link reco-side-_6-swapexacttokensandaddliquidity函数" data-v-106c08ae>6. swapExactTokensAndAddLiquidity函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_7-swapexactethandaddliquidity函数" class="sidebar-link reco-side-_7-swapexactethandaddliquidity函数" data-v-106c08ae>7. swapExactETHAndAddLiquidity函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_8-removeliquidityandswap函数" class="sidebar-link reco-side-_8-removeliquidityandswap函数" data-v-106c08ae>8. _removeLiquidityAndSwap函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_9-removeliquidityandswaptotoken函数" class="sidebar-link reco-side-_9-removeliquidityandswaptotoken函数" data-v-106c08ae>9. removeLiquidityAndSwapToToken函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_10-receive函数" class="sidebar-link reco-side-_10-receive函数" data-v-106c08ae>10. receive函数</a></li><li class="level-3" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#_11-removeliquidityandswaptoeth函数" class="sidebar-link reco-side-_11-removeliquidityandswaptoeth函数" data-v-106c08ae>11. removeLiquidityAndSwapToETH函数</a></li><li class="level-2" data-v-106c08ae><a href="/reco-blog/dapp/uniswap/v2/source-code/ExampleCombinedSwapAddRemoveLiquidity.html#引用及知识拓展" class="sidebar-link reco-side-引用及知识拓展" data-v-106c08ae>引用及知识拓展</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="reco-bgm-panel" data-v-39f9e6e0><audio id="bgm" src="./dream.mp3" data-v-39f9e6e0></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-39f9e6e0 data-v-41bcba48 data-v-39f9e6e0><img src="https://imgessl.kugou.com/stdmusic/20151126/20151126110742332252.jpg" data-v-39f9e6e0></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-39f9e6e0 data-v-41bcba48 data-v-39f9e6e0><div class="reco-bgm-cover" style="background-image:url(https://imgessl.kugou.com/stdmusic/20151126/20151126110742332252.jpg);" data-v-39f9e6e0><div class="mini-operation" style="display:none;" data-v-39f9e6e0><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-39f9e6e0></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-39f9e6e0></i></div> <div class="falut-message" style="display:none;" data-v-39f9e6e0>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-39f9e6e0 data-v-41bcba48 data-v-39f9e6e0><div class="info-box" data-v-39f9e6e0><i class="reco-bgm reco-bgm-music music" data-v-39f9e6e0></i>我的梦</div> <div class="info-box" data-v-39f9e6e0><i class="reco-bgm reco-bgm-artist" data-v-39f9e6e0></i>张靓颖</div> <div class="reco-bgm-progress" data-v-39f9e6e0><div class="progress-bar" data-v-39f9e6e0><div class="bar" data-v-39f9e6e0></div></div></div> <div class="reco-bgm-operation" data-v-39f9e6e0><i class="reco-bgm reco-bgm-last last" data-v-39f9e6e0></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-39f9e6e0></i> <i class="reco-bgm reco-bgm-play play" data-v-39f9e6e0></i> <i class="reco-bgm reco-bgm-next next" data-v-39f9e6e0></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-39f9e6e0></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-39f9e6e0></i> <div class="volume-bar" data-v-39f9e6e0><div class="bar" data-v-39f9e6e0></div></div></div></div> <div class="reco-bgm-left-box" data-v-39f9e6e0 data-v-41bcba48 data-v-39f9e6e0><i class="reco-bgm reco-bgm-left" data-v-39f9e6e0></i></div></div></div></div></div>
    <script src="/reco-blog/assets/js/app.1c503e6d.js" defer></script><script src="/reco-blog/assets/js/5.33311cc0.js" defer></script><script src="/reco-blog/assets/js/1.e254afbc.js" defer></script><script src="/reco-blog/assets/js/25.684f6337.js" defer></script>
  </body>
</html>
